<script>
window.onload = function() {
    console.log('Page loaded');
    
    const fileInput = document.querySelector('input[type="file"]');
    const fileStatus = document.querySelector('.container-select p');
    const uploadButton = document.querySelector('.button');
    const cancelButton = document.querySelector('.cancel-button');
    const uploadForm = document.getElementById('upload-button');
    
    console.log('Elements found:', {
        fileInput: !!fileInput,
        fileStatus: !!fileStatus,
        uploadButton: !!uploadButton,
        cancelButton: !!cancelButton,
        uploadForm: !!uploadForm
    });
    
    if (!fileInput || !fileStatus || !uploadButton || !uploadForm) {
        console.error('Required elements not found');
        return;
    }
    
    // 初期状態
    uploadButton.disabled = true;
    
    // ファイル選択イベント
    fileInput.addEventListener('change', function(e) {
        console.log('File input changed');
        const file = e.target.files[0];
        if (file) {
            console.log('File selected:', file.name, file.type);
            if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                fileStatus.textContent = `選択済み: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                fileStatus.style.color = '#155724';
                fileStatus.style.backgroundColor = '#d4edda';
                uploadButton.disabled = false;
                console.log('Upload button enabled');
            } else {
                fileStatus.textContent = 'CSVファイルを選択してください';
                fileStatus.style.color = '#721c24';
                fileStatus.style.backgroundColor = '#f8d7da';
                uploadButton.disabled = true;
                console.log('Invalid file type');
            }
        } else {
            fileStatus.textContent = '選択されていません';
            fileStatus.style.color = '#666';
            fileStatus.style.backgroundColor = '#f9f9f9';
            uploadButton.disabled = true;
            console.log('No file selected');
        }
    });
    
    // フォーム送信イベント
    uploadForm.addEventListener('submit', function(e) {
        console.log('Form submit triggered');
        e.preventDefault();
        e.stopPropagation();
        
        const file = fileInput.files[0];
        
        if (!file) {
            showStatus('ファイルが選択されていません。', 'error');
            return;
        }
        
        if (!(file.type === 'text/csv' || file.name.endsWith('.csv'))) {
            showStatus('CSVファイルを選択してください。', 'error');
            return;
        }
        
        console.log('Starting file read...');
        showStatus('CSVファイルを読み込み中...', 'info');
        
        const reader = new FileReader();
        reader.onload = function(e) {
            console.log('File read complete, calling server...');
            const csvContent = e.target.result;
            
            google.script.run
                .withSuccessHandler(onUploadSuccess)
                .withFailureHandler(onUploadError)
                .processCsvContent(csvContent);
        };
        
        reader.onerror = function(e) {
            console.error('File read error:', e);
            showStatus('ファイル読み込みエラーが発生しました。', 'error');
        };
        
        reader.readAsText(file, 'UTF-8');
    });
    
    // キャンセルボタンイベント
    if (cancelButton) {
        cancelButton.addEventListener('click', function(e) {
            console.log('Cancel button clicked');
            e.preventDefault();
            google.script.host.close();
        });
    }
};

function onUploadSuccess(result) {
    console.log('Upload success:', result);
    showStatus('CSVファイルの読み込みが完了しました。', 'success');
    setTimeout(() => {
        google.script.host.close();
    }, 2000);
}

function onUploadError(error) {
    console.error('Upload error:', error);
    showStatus('エラー: ' + error.message, 'error');
}

function showStatus(message, type) {
    console.log('Showing status:', message, type);
    let statusDiv = document.querySelector('.status');
    if (!statusDiv) {
        statusDiv = document.createElement('div');
        statusDiv.className = 'status';
        document.querySelector('.container').appendChild(statusDiv);
    }
    
    statusDiv.textContent = message;
    statusDiv.className = 'status ' + type;
    statusDiv.style.display = 'block';
}

function closeDialog() {
    console.log('Close dialog called');
    google.script.host.close();
}

// グローバルに関数を設定（念のため）
window.closeDialog = closeDialog;
window.showStatus = showStatus;
</script>